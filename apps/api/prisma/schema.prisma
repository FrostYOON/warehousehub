generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// ì‚¬ìš©ì ê¶Œí•œ
/// - ADMIN: íšŒì‚¬ ì „ì²´ ê´€ë¦¬ì
/// - WH_MANAGER: ì°½ê³  ê´€ë¦¬ì (ì…ê³ /ì¶œê³ /ì¡°ì • ê°€ëŠ¥)
/// - DELIVERY: ë°°ì†¡ ë‹´ë‹¹ì (ë°°ì†¡ í™•ì¸/ì¶œê³  ê²€í† )
/// - ACCOUNTING: íšŒê³„ ë‹´ë‹¹ì (ì¬ê³  ì¡°íšŒ)
/// - SALES: ì˜ì—… ë‹´ë‹¹ì (ì¬ê³ /ì¶œê³  ì¡°íšŒ)
enum Role {
  ADMIN
  WH_MANAGER
  DELIVERY
  ACCOUNTING
  SALES
}

/// ì°½ê³  íƒ€ì… (íšŒì‚¬ë‹¹ DRY/COOL/FRZ 1ê°œì”© ì¡´ì¬)
enum StorageType {
  DRY // ìƒì˜¨
  COOL // ëƒ‰ì¥
  FRZ // ëƒ‰ë™
}

/// ì¬ê³  ì›ì¥ íŠ¸ëœì­ì…˜ ìœ í˜•
/// ëª¨ë“  ì¬ê³  ì¦ê°ì€ ì´ í…Œì´ë¸”ì— ê¸°ë¡ë¨ (Audit Trail ëª©ì )
enum InventoryTxType {
  INBOUND_CONFIRM // ì…ê³  í™•ì • (onHand ì¦ê°€)
  OUTBOUND_CONFIRM // ì¶œê³  í™•ì • (onHand ê°ì†Œ)
  PICK_RESERVE // í”½ ì˜ˆì•½ (reserved ì¦ê°€)
  PICK_RELEASE // í”½ ì·¨ì†Œ (reserved ê°ì†Œ)
  ADJUSTMENT // ê´€ë¦¬ì ìˆ˜ëŸ‰ ì¡°ì •
  RETURN_RESTOCK // ë¦¬í„´ ì¬ì…ê³ 
  RETURN_DISCARD // ë¦¬í„´ íê¸°
}

/// ì—‘ì…€ ì…ê³  ì—…ë¡œë“œ ìƒíƒœ
enum InboundUploadStatus {
  UPLOADED
  CONFIRMED
  CANCELLED
}

/// ì¶œê³  ì˜¤ë” ìƒíƒœ
enum OutboundStatus {
  DRAFT // ì¶œê³  ìš”ì²­
  PICKING // í”½í‚¹ ì¤‘
  PICKED // í”½ ì™„ë£Œ
  READY_TO_SHIP // ê²€ìˆ˜ ì™„ë£Œ/ì¶œë°œ ì¤€ë¹„
  SHIPPING // ë°°ì†¡ì¤‘
  DELIVERED // ë°°ì†¡(ì¶œê³ ) ì™„ë£Œ
  CANCELLED // ì·¨ì†Œ
}

/// ì¶œê³  ë¼ì¸ ìƒíƒœ
enum OutboundLineStatus {
  ACTIVE
  CANCELLED
}

/// í”½ ë°©ì‹
/// AUTO_FEFO : ì‹œìŠ¤í…œ ìë™ ì„ ì…ì„ ì¶œ
/// MANUAL    : ì°½ê³  ë‹´ë‹¹ìê°€ íŠ¹ì • Lot ì„ íƒ
enum PickSource {
  AUTO_FEFO
  MANUAL
}

/// í•˜ë‚˜ì˜ íšŒì‚¬(í…Œë„ŒíŠ¸)
/// ëª¨ë“  ë°ì´í„°ëŠ” companyId ê¸°ì¤€ìœ¼ë¡œ ê²©ë¦¬ë¨
model Company {
  id   String @id @default(uuid())
  name String @unique

  users      User[]
  warehouses Warehouse[]
  items      Item[]
  customers  Customer[]

  // ì¬ê³  ë„ë©”ì¸
  lots           Lot[]
  stocks         Stock[]
  inventoryTxes  InventoryTx[]
  inboundUploads InboundUpload[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  outboundOrders  OutboundOrder[]
  pickAllocations PickAllocation[]
}

/// íšŒì‚¬ ì†Œì† ì‚¬ìš©ì
/// ê¶Œí•œ(Role)ì— ë”°ë¼ ê¸°ëŠ¥ ì ‘ê·¼ ì œì–´
model User {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  email        String
  passwordHash String
  name         String
  role         Role    @default(WH_MANAGER)
  isActive     Boolean @default(true)

  refreshTokens RefreshToken[]

  /// ì´ ì‚¬ìš©ìê°€ ë°œìƒì‹œí‚¨ ì¬ê³  íŠ¸ëœì­ì…˜
  inventoryTxes InventoryTx[]

  /// ì´ ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì…ê³  ì—‘ì…€
  inboundUploads InboundUpload[]

  createdOutboundOrders         OutboundOrder[] @relation("OutboundCreatedBy")
  confirmedOutboundOrders       OutboundOrder[] @relation("OutboundConfirmedBy")
  verifiedOutboundOrders        OutboundOrder[] @relation("OutboundVerifiedBy")
  shippingStartedOutboundOrders OutboundOrder[] @relation("OutboundShippingStartedBy")
  deliveredOutboundOrders       OutboundOrder[] @relation("OutboundDeliveredBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, email])
}

/// íšŒì‚¬ ë‚´ ì°½ê³ 
/// íšŒì‚¬ë‹¹ DRY/COOL/FRZ ê°ê° 1ê°œ
model Warehouse {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  type StorageType
  name String

  stocks           Stock[]
  inventoryTxLines InventoryTxLine[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  pickAllocations PickAllocation[]

  @@unique([companyId, type])
}

/// ìƒí’ˆ ë§ˆìŠ¤í„°
/// ë™ì¼ íšŒì‚¬ ë‚´ itemCodeëŠ” ìœ ë‹ˆí¬
model Item {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  itemCode String
  itemName String
  isActive Boolean @default(true)

  lots Lot[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  outboundLines OutboundLine[]

  @@unique([companyId, itemCode])
}

model Customer {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  customerName    String
  customerAddress String

  postalCode String?
  city       String?
  state      String?
  country    String?

  lat Decimal? @db.Decimal(10, 7)
  lng Decimal? @db.Decimal(10, 7)

  isActive Boolean @default(true)

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  outboundOrders OutboundOrder[]

  @@index([companyId])
  @@index([customerName])
}

model RefreshToken {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@index([tokenHash])
}

/// ìœ í†µê¸°í•œ ë‹¨ìœ„ ì¬ê³  ê·¸ë£¹
/// expiryDate = null â†’ ìœ í†µê¸°í•œ ì—†ìŒ (ìŒ€/ê¹€ì¹˜ ë“±)
model Lot {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  expiryDate DateTime? // null ê°€ëŠ¥

  stocks           Stock[]
  inventoryTxLines InventoryTxLine[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  pickAllocations PickAllocation[]

  @@unique([companyId, itemId, expiryDate])
}

/// ì°½ê³  + Lot ë‹¨ìœ„ í˜„ì¬ ì¬ê³ 
/// onHand  : ì‹¤ì œ ë³´ìœ  ìˆ˜ëŸ‰
/// reserved: í”½ìœ¼ë¡œ ì˜ˆì•½ëœ ìˆ˜ëŸ‰
model Stock {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  lotId String
  lot   Lot    @relation(fields: [lotId], references: [id], onDelete: Cascade)

  onHand   Int @default(0)
  reserved Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// íšŒì‚¬ + ì°½ê³  + LotëŠ” ìœ ì¼
  @@unique([companyId, warehouseId, lotId])
}

/// ëª¨ë“  ì¬ê³  ë³€ë™ì€ ì—¬ê¸° ê¸°ë¡ë¨
/// ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ì•ŠëŠ” Audit Log
model InventoryTx {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  type InventoryTxType

  /// ì‘ì—…ì
  actorUserId String?
  actorUser   User?   @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  /// ì–´ë–¤ ê¸°ëŠ¥ì—ì„œ ë°œìƒí–ˆëŠ”ì§€ ì¶”ì ìš©
  refType String?
  refId   String?

  memo String?

  lines InventoryTxLine[]

  createdAt DateTime @default(now())
}

/// ì¬ê³  ë³€ë™ ìƒì„¸ ë¼ì¸
/// qtyDelta: +ë©´ ì¦ê°€, -ë©´ ê°ì†Œ
model InventoryTxLine {
  id   String      @id @default(uuid())
  txId String
  tx   InventoryTx @relation(fields: [txId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  lotId String
  lot   Lot    @relation(fields: [lotId], references: [id], onDelete: Cascade)

  qtyDelta Int

  createdAt DateTime @default(now())
}

model InboundUpload {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  uploadedByUserId String?
  uploadedByUser   User?   @relation(fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  fileName    String
  status      InboundUploadStatus @default(UPLOADED)
  createdAt   DateTime            @default(now())
  confirmedAt DateTime?

  rows InboundUploadRow[]

  @@index([companyId, status])
  @@index([companyId, createdAt])
}

model InboundUploadRow {
  id       String        @id @default(uuid())
  uploadId String
  upload   InboundUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  itemCode    String
  itemName    String
  storageType StorageType
  quantity    Int
  expiryDate  DateTime?

  isValid      Boolean @default(true)
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([uploadId])
  @@index([itemCode])
}

/// ì¶œê³  ì£¼ë¬¸ í—¤ë”
/// plannedDate ê¸°ì¤€ìœ¼ë¡œ ì˜¤ëŠ˜~ë¯¸ë˜ ì¶œê³  ê´€ë¦¬
model OutboundOrder {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  plannedDate DateTime

  title  String?
  status OutboundStatus @default(DRAFT)

  createdByUserId String?
  createdByUser   User?   @relation("OutboundCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  confirmedByUserId String?
  confirmedByUser   User?   @relation("OutboundConfirmedBy", fields: [confirmedByUserId], references: [id], onDelete: SetNull)

  verifiedByUserId String?
  verifiedByUser   User?     @relation("OutboundVerifiedBy", fields: [verifiedByUserId], references: [id], onDelete: SetNull)
  verifiedAt       DateTime?

  shippingStartedByUserId String?
  shippingStartedByUser   User?     @relation("OutboundShippingStartedBy", fields: [shippingStartedByUserId], references: [id], onDelete: SetNull)
  shippingStartedAt       DateTime?

  deliveredByUserId String?
  deliveredByUser   User?     @relation("OutboundDeliveredBy", fields: [deliveredByUserId], references: [id], onDelete: SetNull)
  deliveredAt       DateTime?

  confirmedAt DateTime?
  memo        String?

  lines OutboundLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, status])
  @@index([companyId, plannedDate])
  @@index([companyId, customerId])
}

/// ì¶œê³  í’ˆëª© ë¼ì¸
/// requestedQty : ìš”ì²­ ìˆ˜ëŸ‰
/// pickedQty    : ì˜ˆì•½ ìˆ˜ëŸ‰ í•©ê³„
/// shippedQty   : ì‹¤ì œ ì¶œê³  ìˆ˜ëŸ‰
model OutboundLine {
  id      String        @id @default(uuid())
  orderId String
  order   OutboundOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Restrict)

  requestedQty Int
  pickedQty    Int @default(0)
  shippedQty   Int @default(0)

  status OutboundLineStatus @default(ACTIVE)

  createdAt       DateTime         @default(now())
  pickAllocations PickAllocation[]

  @@index([orderId])
  @@index([itemId])
}

/// í”½ ì˜ˆì•½ ê¸°ë¡
/// Lot ë‹¨ìœ„ë¡œ ì˜ˆì•½í•´ì•¼ FEFO ê°€ëŠ¥
model PickAllocation {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  outboundLineId String
  outboundLine   OutboundLine @relation(fields: [outboundLineId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Restrict)

  lotId String
  lot   Lot    @relation(fields: [lotId], references: [id], onDelete: Restrict)

  qty Int

  /// ğŸ”¹ í”½ ë°©ì‹ (ìë™ / ìˆ˜ë™)
  source PickSource @default(AUTO_FEFO)

  /// ì˜ˆì•½ í•´ì œ ì—¬ë¶€
  isReleased Boolean   @default(false)
  releasedAt DateTime?

  /// ì¶œê³  í™•ì • ë°˜ì˜ ì—¬ë¶€
  isCommitted Boolean   @default(false)
  committedAt DateTime?

  createdAt DateTime @default(now())

  @@index([companyId, outboundLineId])
  @@index([companyId, warehouseId, lotId])
}
